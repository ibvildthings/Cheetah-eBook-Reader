<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBook Reader v3.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 320px;
            background: #1a1a1a;
            color: #e8e8e8;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 13px;
            color: #a0a0a0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: #60a5fa;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #2a2a2a;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #60a5fa;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #60a5fa;
            cursor: pointer;
            border: none;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        button {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #2a2a2a;
            background: #2a2a2a;
            color: #e8e8e8;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: #3a3a3a;
            border-color: #3a3a3a;
        }

        button.active {
            background: #60a5fa;
            border-color: #60a5fa;
            color: #fff;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #2a2a2a;
            background: #2a2a2a;
            color: #e8e8e8;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        #reader-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .margin-drag-zone {
            position: absolute;
            top: 0;
            height: 100%;
            cursor: ew-resize;
            z-index: 100;
            transition: background 0.2s, border-color 0.2s;
            border: 1px dashed transparent;
            pointer-events: auto;
        }

        .margin-drag-zone-left {
            left: 0;
        }

        .margin-drag-zone-right {
            right: 0;
        }

        .margin-drag-zone:hover {
            background: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .margin-drag-zone.dragging {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <div class="sidebar-section">
                <h3>Reading Mode</h3>
                <div class="btn-group">
                    <button id="btn-normal" class="active">Normal</button>
                    <button id="btn-flow">Flow</button>
                </div>
                <div class="btn-group">
                    <button id="btn-bionic">Bionic</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Flow Controls</h3>
                <div class="btn-group">
                    <button id="btn-play">▶ Play</button>
                </div>
                <div class="control-group">
                    <label>Speed <span class="control-value" id="speed-value">300 WPM</span></label>
                    <input type="range" id="speed-slider" min="100" max="600" value="300">
                </div>
                <div class="control-group">
                    <label>Focus Width <span class="control-value" id="focus-value">2</span></label>
                    <input type="range" id="focus-slider" min="1" max="5" value="2">
                </div>
                <div class="control-group">
                    <label>Scroll Level <span class="control-value" id="scroll-value">1</span></label>
                    <input type="range" id="scroll-slider" min="1" max="5" value="1">
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Typography</h3>
                <div class="control-group">
                    <label>Font Family</label>
                    <select id="font-select">
                        <optgroup label="Serif">
                            <option value="georgia" selected>Georgia</option>
                            <option value="merriweather">Merriweather</option>
                            <option value="lora">Lora</option>
                            <option value="crimson">Crimson Pro</option>
                            <option value="baskerville">Libre Baskerville</option>
                        </optgroup>
                        <optgroup label="Sans Serif">
                            <option value="inter">Inter</option>
                            <option value="opensans">Open Sans</option>
                            <option value="sourcesans">Source Sans 3</option>
                            <option value="nunito">Nunito Sans</option>
                        </optgroup>
                        <optgroup label="Monospace">
                            <option value="jetbrains">JetBrains Mono</option>
                            <option value="fira">Fira Mono</option>
                        </optgroup>
                        <optgroup label="Slab">
                            <option value="robotoslab">Roboto Slab</option>
                        </optgroup>
                    </select>
                </div>
                <div class="control-group">
                    <label>Font Size <span class="control-value" id="fontsize-value">18px</span></label>
                    <input type="range" id="fontsize-slider" min="12" max="48" value="18">
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Layout</h3>
                <div class="control-group">
                    <label>Left Margin <span class="control-value" id="margin-left-value">60px</span></label>
                    <input type="range" id="margin-left-slider" min="10" max="400" value="60">
                </div>
                <div class="control-group">
                    <label>Right Margin <span class="control-value" id="margin-right-value">60px</span></label>
                    <input type="range" id="margin-right-slider" min="10" max="400" value="60">
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Theme</h3>
                <div class="btn-group">
                    <button id="theme-light" class="active">Light</button>
                    <button id="theme-dark">Dark</button>
                </div>
                <div class="btn-group">
                    <button id="theme-sepia">Sepia</button>
                    <button id="theme-gray">Gray</button>
                </div>
                <div class="btn-group">
                    <button id="theme-auto">Auto</button>
                </div>
            </div>
        </div>

        <div id="reader-container">
            <div class="margin-drag-zone margin-drag-zone-left" id="drag-left"></div>
            <div class="margin-drag-zone margin-drag-zone-right" id="drag-right"></div>
            <div id="reader"></div>
        </div>
    </div>

    <script src="ebook-reader.js"></script>
    <script>
        const sampleText = `<h1>Chapter One: The Beginning</h1>
            <p>In the heart of Silicon Valley, where innovation breathed life into dreams and ambition fueled the relentless pursuit of progress, there existed a small startup that dared to challenge the giants. The morning sun cast long shadows through the floor-to-ceiling windows of their modest office, illuminating screens filled with code and whiteboards covered in sketches of impossible ideas.</p>
            <p>Sarah had always believed that the best products were born from frustration. It was a Tuesday afternoon when she threw her e-reader across the room—not hard enough to break it, but with enough force to express her complete dissatisfaction with the experience. "Why," she asked her co-founder Marcus, "does every reading app feel like it was designed in 2010?"</p>
            <p>Marcus looked up from his laptop, his fingers still hovering over the keyboard. He'd been wrestling with the same question for months. The reading experience hadn't evolved. Sure, screens got sharper and devices got thinner, but the fundamental interaction between human and text remained stubbornly unchanged.</p>
            <p>They spent the next six months in a frenzy of prototyping. Coffee cups multiplied across their desks. Whiteboards filled with user flow diagrams. They interviewed hundreds of readers—commuters on trains, students in libraries, professionals in coffee shops. What they discovered was simple: people didn't just want to read faster. They wanted to read better.</p>
            <p>The breakthrough came on a rainy November evening. Sarah was testing their latest prototype when something clicked. The text moved with her eyes, not against them. Words highlighted in rhythm with her reading speed. It felt like the book was reading her mind.</p>
            <p>"This is it," she whispered, looking up at Marcus with wide eyes. "This is what we've been searching for."</p>
            <p>Marcus leaned over her shoulder, watching the prototype in action. For the first time in months, he smiled. Really smiled. Not the forced grin of another failed demo, but the genuine expression of someone who knew they'd created something special.</p>
            <p>They called it Flow Mode. The name came naturally—it was exactly how reading felt when everything worked perfectly. No friction. No distraction. Just you and the words, moving together in perfect harmony.</p>`;

        const reader = new EBookReader('#reader');
        reader.loadContent(sampleText);

        // Margin state management
        let marginState = { left: 60, right: 60, dragging: false, side: null, initX: 0, initMargin: 0 };

        function updateMargins() {
            const content = document.querySelector('.ebook-text-content');
            if (content) {
                content.style.paddingLeft = marginState.left + 'px';
                content.style.paddingRight = marginState.right + 'px';
            }
            
            document.getElementById('drag-left').style.width = Math.max(60, marginState.left) + 'px';
            document.getElementById('drag-right').style.width = Math.max(60, marginState.right) + 'px';
            document.getElementById('margin-left-value').textContent = marginState.left + 'px';
            document.getElementById('margin-right-value').textContent = marginState.right + 'px';
            
            // CRITICAL: Tell library layout changed
            reader.updateLayout();
        }

        function startDrag(e, side) {
            e.preventDefault();
            marginState.dragging = true;
            marginState.side = side;
            marginState.initX = e.touches?.[0]?.clientX || e.clientX;
            marginState.initMargin = side === 'left' ? marginState.left : marginState.right;
            document.getElementById(`drag-${side}`).classList.add('dragging');
        }

        function handleDrag(e) {
            if (!marginState.dragging) return;
            const x = e.touches?.[0]?.clientX || e.clientX;
            const delta = x - marginState.initX;
            let val = marginState.initMargin + (marginState.side === 'left' ? delta : -delta);
            val = Math.max(10, Math.min(400, val));
            marginState[marginState.side] = val;
            updateMargins();
        }

        function stopDrag() {
            if (marginState.dragging) {
                document.getElementById(`drag-${marginState.side}`)?.classList.remove('dragging');
            }
            marginState.dragging = false;
        }

        ['mousedown', 'touchstart'].forEach(e => {
            document.getElementById('drag-left').addEventListener(e, ev => startDrag(ev, 'left'));
            document.getElementById('drag-right').addEventListener(e, ev => startDrag(ev, 'right'));
        });
        ['mousemove', 'touchmove'].forEach(e => document.addEventListener(e, handleDrag));
        ['mouseup', 'touchend'].forEach(e => document.addEventListener(e, stopDrag));

        document.getElementById('margin-left-slider').addEventListener('input', e => {
            marginState.left = parseInt(e.target.value);
            updateMargins();
        });
        document.getElementById('margin-right-slider').addEventListener('input', e => {
            marginState.right = parseInt(e.target.value);
            updateMargins();
        });

        // All other controls (copy from your existing app)
        document.getElementById('btn-normal').addEventListener('click', () => {
            reader.setMode('normal');
            document.getElementById('btn-normal').classList.add('active');
            document.getElementById('btn-flow').classList.remove('active');
        });

        document.getElementById('btn-flow').addEventListener('click', () => {
            reader.setMode('flow');
            document.getElementById('btn-flow').classList.add('active');
            document.getElementById('btn-normal').classList.remove('active');
        });

        document.getElementById('btn-bionic').addEventListener('click', function() {
            reader.setBionic(!reader.getState().bionic);
            this.classList.toggle('active');
        });

        document.getElementById('btn-play').addEventListener('click', function() {
            reader.togglePlay();
            const state = reader.getState();
            this.textContent = state.isPlaying ? '⏸ Pause' : '▶ Play';
        });

        document.getElementById('speed-slider').addEventListener('input', e => {
            reader.setSpeed(parseInt(e.target.value));
            document.getElementById('speed-value').textContent = e.target.value + ' WPM';
        });

        document.getElementById('focus-slider').addEventListener('input', e => {
            reader.setFocusWidth(parseInt(e.target.value));
            document.getElementById('focus-value').textContent = e.target.value;
        });

        document.getElementById('scroll-slider').addEventListener('input', e => {
            reader.setScrollLevel(parseInt(e.target.value));
            document.getElementById('scroll-value').textContent = e.target.value;
        });

        document.getElementById('font-select').addEventListener('change', e => {
            reader.setFont(e.target.value);
        });

        document.getElementById('fontsize-slider').addEventListener('input', e => {
            reader.setFontSize(parseInt(e.target.value));
            document.getElementById('fontsize-value').textContent = e.target.value + 'px';
        });

        ['light', 'dark', 'sepia', 'gray'].forEach(theme => {
            document.getElementById(`theme-${theme}`).addEventListener('click', function() {
                reader.setTheme(theme);
                document.querySelectorAll('[id^="theme-"]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.getElementById('theme-auto').addEventListener('click', function() {
            reader.setAutoTheme(true);
            document.querySelectorAll('[id^="theme-"]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });

        setTimeout(updateMargins, 100);
    </script>
</body>
</html>